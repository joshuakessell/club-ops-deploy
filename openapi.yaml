openapi: 3.0.3
info:
  title: Club Operations POS API
  version: 1.0.0
  description: |
    Server-authoritative REST API for managing club check-ins, room/locker assignments,
    cleaning workflows, checkout verification, and operational reporting.

    All endpoints are versioned under `/v1`.
    Request bodies are validated with Zod schemas.

    Authentication:
    - Staff endpoints require Bearer token (session token from PIN or WebAuthn login)
    - Admin endpoints require ADMIN role in addition to authentication
    - Customer-facing endpoints (agreement signing, checkout kiosk) do not require auth

servers:
  - url: http://localhost:3001
    description: Local development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Authentication
    description: Staff authentication (PIN and WebAuthn)
  - name: Check-in
    description: Lane session management and check-in flow
  - name: Inventory
    description: Room and locker availability
  - name: Cleaning
    description: Room status transitions for cleaning workflow
  - name: Checkout
    description: Customer checkout initiation and staff verification
  - name: Agreements
    description: Agreement management and signatures
  - name: Upgrades
    description: Waitlist and upgrade processing
  - name: Visits
    description: Visit and renewal management
  - name: Admin
    description: Admin-only operations (staff management, metrics)
  - name: Metrics
    description: Operational metrics and analytics
  - name: Keys
    description: Key tag resolution
  - name: Documents
    description: Agreement PDF + signature verification endpoints
  - name: Telemetry
    description: Best-effort UI + backend telemetry ingestion

paths:
  /v1/health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  uptime:
                    type: number
                    example: 12345

  /v1/telemetry:
    post:
      tags: [Telemetry]
      summary: Ingest telemetry events (single or batch)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  description: Single event
                  properties:
                    timestamp: { oneOf: [{ type: string }, { type: number }] }
                    app: { type: string }
                    level: { type: string, enum: [error, warn, info] }
                    kind: { type: string }
                    route: { type: string }
                    message: { type: string }
                    stack: { type: string }
                    requestId: { type: string }
                    sessionId: { type: string }
                    deviceId: { type: string }
                    lane: { type: string }
                    method: { type: string }
                    status: { type: integer }
                    url: { type: string }
                    meta: { type: object, additionalProperties: true }
                - type: array
                  description: Batch of events
                  items:
                    type: object
                    properties:
                      timestamp: { oneOf: [{ type: string }, { type: number }] }
                      app: { type: string }
                      level: { type: string, enum: [error, warn, info] }
                      kind: { type: string }
                      route: { type: string }
                      message: { type: string }
                      stack: { type: string }
                      requestId: { type: string }
                      sessionId: { type: string }
                      deviceId: { type: string }
                      lane: { type: string }
                      method: { type: string }
                      status: { type: integer }
                      url: { type: string }
                      meta: { type: object, additionalProperties: true }
                - type: object
                  description: Batch envelope
                  properties:
                    events:
                      type: array
                      items:
                        type: object
                        properties:
                          timestamp: { oneOf: [{ type: string }, { type: number }] }
                          app: { type: string }
                          level: { type: string, enum: [error, warn, info] }
                          kind: { type: string }
                          route: { type: string }
                          message: { type: string }
                          stack: { type: string }
                          requestId: { type: string }
                          sessionId: { type: string }
                          deviceId: { type: string }
                          lane: { type: string }
                          method: { type: string }
                          status: { type: integer }
                          url: { type: string }
                          meta: { type: object, additionalProperties: true }
      responses:
        '200':
          description: Always OK (best-effort ingestion)

  /v1/auth/login-pin:
    post:
      tags: [Authentication]
      summary: Staff login with PIN
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [staffLookup, deviceId, pin]
              properties:
                staffLookup:
                  type: string
                  description: Staff ID or name
                deviceId:
                  type: string
                pin:
                  type: string
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  staffId: { type: string, format: uuid }
                  name: { type: string }
                  role: { type: string, enum: [STAFF, ADMIN] }
                  sessionToken: { type: string }
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                type: object
                properties:
                  error: { type: string }
                  message: { type: string }

  /v1/auth/staff:
    get:
      tags: [Authentication]
      summary: List active staff for login selection
      responses:
        '200':
          description: Staff list
          content:
            application/json:
              schema:
                type: object
                properties:
                  staff:
                    type: array
                    items:
                      type: object
                      properties:
                        id: { type: string, format: uuid }
                        name: { type: string }
                        role: { type: string, enum: [STAFF, ADMIN] }

  /v1/auth/logout:
    post:
      tags: [Authentication]
      summary: Staff logout (revoke current session token)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                type: object
                properties:
                  error: { type: string }
                  message: { type: string }

  /v1/auth/me:
    get:
      tags: [Authentication]
      summary: Get current staff identity
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current staff identity
          content:
            application/json:
              schema:
                type: object
                properties:
                  staffId: { type: string, format: uuid }
                  name: { type: string }
                  role: { type: string, enum: [STAFF, ADMIN] }
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                type: object
                properties:
                  error: { type: string }
                  message: { type: string }

  /v1/auth/reauth-pin:
    post:
      tags: [Authentication]
      summary: Re-authenticate with PIN for sensitive actions (sets reauth_ok_until)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pin]
              properties:
                pin:
                  type: string
      responses:
        '200':
          description: Re-auth successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  reauthOkUntil: { type: string, format: date-time }
        '400':
          description: Validation failed
        '401':
          description: Unauthorized

  /v1/auth/reauth/webauthn/options:
    post:
      tags: [Authentication]
      summary: Get WebAuthn re-authentication options
      security:
        - bearerAuth: []
      responses:
        '200':
          description: WebAuthn authentication options (server-generated)
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '400':
          description: No passkeys registered / invalid request
        '401':
          description: Unauthorized

  /v1/auth/reauth/webauthn/verify:
    post:
      tags: [Authentication]
      summary: Verify WebAuthn re-authentication (sets reauth_ok_until)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [credentialResponse]
              properties:
                credentialResponse:
                  type: object
                  additionalProperties: true
                deviceId:
                  type: string
      responses:
        '200':
          description: Re-auth successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  reauthOkUntil: { type: string, format: date-time }
        '400':
          description: Invalid/expired challenge or verification failed
        '401':
          description: Unauthorized

  /v1/auth/webauthn/registration/options:
    post:
      tags: [Authentication]
      summary: Generate WebAuthn registration options
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [staffId, deviceId]
              properties:
                staffId:
                  type: string
                  format: uuid
                deviceId:
                  type: string
      responses:
        '200':
          description: Registration options

  /v1/auth/webauthn/registration/verify:
    post:
      tags: [Authentication]
      summary: Verify WebAuthn registration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [staffId, deviceId, credentialResponse]
              properties:
                staffId:
                  type: string
                  format: uuid
                deviceId:
                  type: string
                credentialResponse:
                  type: object
      responses:
        '200':
          description: Registration verified

  /v1/auth/webauthn/authentication/options:
    post:
      tags: [Authentication]
      summary: Generate WebAuthn authentication options
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [staffLookup, deviceId]
              properties:
                staffLookup:
                  type: string
                deviceId:
                  type: string
      responses:
        '200':
          description: Authentication options

  /v1/auth/webauthn/authentication/verify:
    post:
      tags: [Authentication]
      summary: Verify WebAuthn authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [deviceId, credentialResponse]
              properties:
                deviceId:
                  type: string
                credentialResponse:
                  type: object
      responses:
        '200':
          description: Authentication verified

  /v1/checkin/lane/{laneId}/start:
    post:
      tags: [Check-in]
      summary: Start lane session (by customerId or ID/membership scan)
      security:
        - bearerAuth: []
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                customerId:
                  type: string
                  format: uuid
                idScanValue:
                  type: string
                membershipScanValue:
                  type: string
                visitId:
                  type: string
                  format: uuid
              anyOf:
                - required: [customerId]
                - required: [idScanValue]
      responses:
        '200':
          description: Lane session created/updated
        '401':
          description: Unauthorized
        '409':
          description: Customer already checked in (active visit exists)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  code:
                    type: string
                    enum: [ALREADY_CHECKED_IN]
                  activeCheckin:
                    type: object
                    nullable: true
                    properties:
                      visitId:
                        type: string
                        format: uuid
                      rentalType:
                        type: string
                        nullable: true
                      assignedResourceType:
                        type: string
                        nullable: true
                        enum: [room, locker]
                      assignedResourceNumber:
                        type: string
                        nullable: true
                      checkinAt:
                        type: string
                        nullable: true
                      checkoutAt:
                        type: string
                        nullable: true
                      overdue:
                        type: boolean
                        nullable: true
                      waitlist:
                        type: object
                        nullable: true
                        properties:
                          id:
                            type: string
                            format: uuid
                          desiredTier:
                            type: string
                          backupTier:
                            type: string
                          status:
                            type: string

  /v1/checkin/scan:
    post:
      tags: [Check-in]
      summary: Normalize/classify a raw scan and resolve customer identity (server-side)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [laneId, rawScanText]
              properties:
                laneId:
                  type: string
                  description: Lane identifier (e.g. lane-1 or lane-2)
                rawScanText:
                  type: string
                  description: Raw decoded scan text from a keyboard-wedge scanner (may include newlines)
                selectedCustomerId:
                  type: string
                  format: uuid
                  nullable: true
                  description: Optional employee-selected customer id to resolve MULTIPLE_MATCHES (STATE_ID scans only)
      responses:
        '200':
          description: Scan resolved (matched or no-match)
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: string
                    enum: [MATCHED, NO_MATCH, MULTIPLE_MATCHES, ERROR]
                  scanType:
                    type: string
                    enum: [STATE_ID, MEMBERSHIP]
                  normalizedRawScanText:
                    type: string
                  idScanHash:
                    type: string
                    nullable: true
                  membershipCandidate:
                    type: string
                    nullable: true
                  candidates:
                    type: array
                    nullable: true
                    description: Present only when result=MULTIPLE_MATCHES (STATE_ID scans)
                    items:
                      type: object
                      required: [id, name, dob, membershipNumber, matchScore]
                      properties:
                        id:
                          type: string
                          format: uuid
                        name:
                          type: string
                        dob:
                          type: string
                          nullable: true
                          description: YYYY-MM-DD or null
                        membershipNumber:
                          type: string
                          nullable: true
                        matchScore:
                          type: number
                          minimum: 0
                          maximum: 1
                  customer:
                    type: object
                    nullable: true
                    properties:
                      id:
                        type: string
                        format: uuid
                      name:
                        type: string
                      dob:
                        type: string
                        nullable: true
                      membershipNumber:
                        type: string
                        nullable: true
                  extracted:
                    type: object
                    nullable: true
                    properties:
                      firstName:
                        type: string
                      lastName:
                        type: string
                      fullName:
                        type: string
                      dob:
                        type: string
                      idNumber:
                        type: string
                      issuer:
                        type: string
                      jurisdiction:
                        type: string
                  enriched:
                    type: boolean
                    nullable: true
                  error:
                    type: object
                    nullable: true
                    properties:
                      code:
                        type: string
                      message:
                        type: string
        '400':
          description: Invalid scan input
        '401':
          description: Unauthorized
        '403':
          description: Customer banned

  /v1/customers/create-from-scan:
    post:
      tags: [Check-in]
      summary: Create (or return existing) customer from extracted ID scan fields (NO_MATCH flow)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [firstName, lastName, dob]
              properties:
                idScanValue:
                  type: string
                  description: Normalized scan value (preferred, from /v1/checkin/scan)
                idScanHash:
                  type: string
                  description: sha256 hash for the normalized scan value (preferred, from /v1/checkin/scan)
                rawScanText:
                  type: string
                  description: Raw scan text (fallback; server will normalize/hash)
                firstName:
                  type: string
                lastName:
                  type: string
                dob:
                  type: string
                  description: Date of birth YYYY-MM-DD
                fullName:
                  type: string
                addressLine1:
                  type: string
                city:
                  type: string
                state:
                  type: string
                postalCode:
                  type: string
      responses:
        '200':
          description: Customer created or returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    type: boolean
                  customer:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      name:
                        type: string
                      dob:
                        type: string
                        nullable: true
                      membershipNumber:
                        type: string
                        nullable: true
        '400':
          description: Validation failed
        '401':
          description: Unauthorized
        '403':
          description: Customer banned

  /v1/customers/match-identity:
    post:
      tags: [Customers]
      summary: Match existing customer by (firstName, lastName, dob) for manual entry duplicate prevention
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [firstName, lastName, dob]
              properties:
                firstName:
                  type: string
                lastName:
                  type: string
                dob:
                  type: string
                  description: Date of birth YYYY-MM-DD
      responses:
        '200':
          description: Match result
          content:
            application/json:
              schema:
                type: object
                properties:
                  matchCount:
                    type: integer
                  bestMatch:
                    type: object
                    nullable: true
                    properties:
                      id:
                        type: string
                        format: uuid
                      name:
                        type: string
                      dob:
                        type: string
                        nullable: true
                      membershipNumber:
                        type: string
                        nullable: true
        '400':
          description: Validation failed
        '401':
          description: Unauthorized

  /v1/customers/create-manual:
    post:
      tags: [Customers]
      summary: Create customer from manual entry (firstName, lastName, dob) without de-duping
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [firstName, lastName, dob]
              properties:
                firstName:
                  type: string
                lastName:
                  type: string
                dob:
                  type: string
                  description: Date of birth YYYY-MM-DD
      responses:
        '200':
          description: Customer created
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    type: boolean
                  customer:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      name:
                        type: string
                      dob:
                        type: string
                        nullable: true
                      membershipNumber:
                        type: string
                        nullable: true
        '400':
          description: Validation failed
        '401':
          description: Unauthorized

  /v1/checkin/lane/{laneId}/scan-id:
    post:
      tags: [Check-in]
      summary: Scan ID (PDF417 barcode) to identify customer and start/update lane session
      security:
        - bearerAuth: []
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                raw:
                  type: string
                  description: Raw PDF417 barcode string (recommended if available)
                firstName:
                  type: string
                lastName:
                  type: string
                fullName:
                  type: string
                  description: Full name if first/last not available separately
                dob:
                  type: string
                  format: date
                  description: Date of birth in ISO YYYY-MM-DD format
                idNumber:
                  type: string
                  description: ID number/license number
                issuer:
                  type: string
                  description: Issuing jurisdiction/state
                jurisdiction:
                  type: string
                  description: Alternative field name for issuer
              required: []
              description: At least one identifier (raw, fullName, firstName+lastName, or idNumber) must be provided
      responses:
        '200':
          description: ID scanned, customer upserted, lane session updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                    format: uuid
                  customerId:
                    type: string
                    format: uuid
                  customerName:
                    type: string
                  allowedRentals:
                    type: array
                    items:
                      type: string
                  mode:
                    type: string
                    enum: [INITIAL, RENEWAL]
        '400':
          description: Invalid input or unable to determine customer name
        '401':
          description: Unauthorized
        '403':
          description: Customer is banned
        '409':
          description: Customer already checked in (active visit exists)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  code:
                    type: string
                    enum: [ALREADY_CHECKED_IN]
                  activeCheckin:
                    type: object
                    nullable: true
                    properties:
                      visitId:
                        type: string
                        format: uuid
                      rentalType:
                        type: string
                        nullable: true
                      assignedResourceType:
                        type: string
                        nullable: true
                        enum: [room, locker]
                      assignedResourceNumber:
                        type: string
                        nullable: true
                      checkinAt:
                        type: string
                        nullable: true
                      checkoutAt:
                        type: string
                        nullable: true
                      overdue:
                        type: boolean
                        nullable: true
                      waitlist:
                        type: object
                        nullable: true
                        properties:
                          id:
                            type: string
                            format: uuid
                          desiredTier:
                            type: string
                          backupTier:
                            type: string
                          status:
                            type: string

  /v1/checkin/lane/{laneId}/select-rental:
    post:
      tags: [Check-in]
      summary: Customer selects rental preference
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [rentalType]
              properties:
                rentalType:
                  type: string
                  enum: [LOCKER, STANDARD, DOUBLE, SPECIAL, GYM_LOCKER]
      responses:
        '200':
          description: Rental selection recorded

  /v1/checkin/lane/{laneId}/propose-selection:
    post:
      tags: [Check-in]
      summary: Propose a rental type selection (customer or employee)
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [rentalType, proposedBy]
              properties:
                rentalType:
                  type: string
                  enum: [LOCKER, STANDARD, DOUBLE, SPECIAL, GYM_LOCKER]
                proposedBy:
                  type: string
                  enum: [CUSTOMER, EMPLOYEE]
                waitlistDesiredType:
                  type: string
                  enum: [LOCKER, STANDARD, DOUBLE, SPECIAL, GYM_LOCKER]
                backupRentalType:
                  type: string
                  enum: [LOCKER, STANDARD, DOUBLE, SPECIAL, GYM_LOCKER]
      responses:
        '200':
          description: Selection proposed
        '400':
          description: Invalid input or session not found
        '401':
          description: Unauthorized (for employee proposals)

  /v1/checkin/lane/{laneId}/confirm-selection:
    post:
      tags: [Check-in]
      summary: Confirm the proposed selection (first confirmation locks it)
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [confirmedBy]
              properties:
                confirmedBy:
                  type: string
                  enum: [CUSTOMER, EMPLOYEE]
      responses:
        '200':
          description: Selection confirmed and locked
        '400':
          description: Invalid input or session not found
        '401':
          description: Unauthorized (for employee confirmations)

  /v1/checkin/lane/{laneId}/membership-purchase-intent:
    post:
      tags: [Check-in]
      summary: Customer kiosk requests a 6-month membership purchase/renewal to include in the payment quote
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [intent]
              properties:
                intent:
                  type: string
                  enum: [PURCHASE, RENEW, NONE]
                  description: When NONE, clears any previously requested 6-month membership purchase/renewal intent.
                sessionId:
                  type: string
                  format: uuid
                  description: Optional lane session id; if omitted, the server uses the latest active session for the lane.
      responses:
        '200':
          description: Membership purchase intent recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Invalid input or session not found
        '404':
          description: No active session found

  /v1/checkin/lane/{laneId}/membership-choice:
    post:
      tags: [Check-in]
      summary: Persist the kiosk membership-step choice (ONE_TIME vs SIX_MONTH) for the active lane session
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [choice]
              properties:
                choice:
                  type: string
                  enum: [ONE_TIME, SIX_MONTH, NONE]
                  description: When NONE, clears any previously stored membership choice.
                sessionId:
                  type: string
                  format: uuid
                  description: Optional lane session id; if omitted, the server uses the latest active session for the lane.
      responses:
        '200':
          description: Membership choice recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Invalid input or session not found
        '404':
          description: No active session found

  /v1/checkin/lane/{laneId}/highlight-option:
    post:
      tags: [Check-in]
      summary: Ephemeral kiosk UI highlight for employee pending selections (LANGUAGE/MEMBERSHIP)
      security:
        - bearerAuth: []
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [step]
              properties:
                step:
                  type: string
                  enum: [LANGUAGE, MEMBERSHIP]
                option:
                  type: string
                  nullable: true
                  description: Option identifier for the step; null clears the highlight.
                sessionId:
                  type: string
                  format: uuid
                  description: Optional lane session id; if omitted, the server uses the latest active session for the lane.
      responses:
        '200':
          description: Highlight broadcast to lane
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Invalid input or session not found
        '401':
          description: Unauthorized
        '404':
          description: No active session found

  /v1/checkin/lane/{laneId}/complete-membership-purchase:
    post:
      tags: [Check-in]
      summary: After membership payment is accepted, staff enters membership number to activate 6-month membership
      security:
        - bearerAuth: []
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [membershipNumber]
              properties:
                sessionId:
                  type: string
                  format: uuid
                  description: Optional lane session id; if omitted, the server uses the latest active session for the lane.
                membershipNumber:
                  type: string
                  description: Physical membership number from the card (scanner wedge input supported client-side).
      responses:
        '200':
          description: Membership activated and pending intent cleared
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Invalid input or session not eligible
        '401':
          description: Unauthorized
        '404':
          description: No active session or payment intent not found

  /v1/checkin/lane/{laneId}/acknowledge-selection:
    post:
      tags: [Check-in]
      summary: Acknowledge a locked selection (required for the other side to proceed)
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [acknowledgedBy]
              properties:
                acknowledgedBy:
                  type: string
                  enum: [CUSTOMER, EMPLOYEE]
      responses:
        '200':
          description: Selection acknowledged
        '400':
          description: Invalid input or session not found
        '401':
          description: Unauthorized (for employee acknowledgements)

  /v1/checkin/lane/{laneId}/waitlist-info:
    get:
      tags: [Check-in]
      summary: Get waitlist position, ETA, and upgrade fee for a desired tier
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
        - name: desiredTier
          in: query
          required: true
          schema:
            type: string
            enum: [LOCKER, STANDARD, DOUBLE, SPECIAL, GYM_LOCKER]
        - name: currentTier
          in: query
          schema:
            type: string
            enum: [LOCKER, STANDARD, DOUBLE, SPECIAL, GYM_LOCKER]
      responses:
        '200':
          description: Waitlist information
          content:
            application/json:
              schema:
                type: object
                properties:
                  position:
                    type: integer
                  estimatedReadyAt:
                    type: string
                    format: date-time
                    nullable: true
                  upgradeFee:
                    type: number
        '400':
          description: Invalid input or session not found

  /v1/checkin/lane/{laneId}/assign:
    post:
      tags: [Check-in]
      summary: Assign room/locker with transactional locking
      security:
        - bearerAuth: []
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [resourceId, resourceType]
              properties:
                resourceId:
                  type: string
                  format: uuid
                resourceType:
                  type: string
                  enum: [room, locker]
      responses:
        '200':
          description: Assignment successful
        '409':
          description: Resource already assigned

  /v1/checkin/lane/{laneId}/create-payment-intent:
    post:
      tags: [Check-in]
      summary: Create payment intent from price quote
      security:
        - bearerAuth: []
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Payment intent created

  /v1/payments/{id}/mark-paid:
    post:
      tags: [Check-in]
      summary: Mark payment intent as paid (after Square payment)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Payment marked as paid

  /v1/checkin/lane/{laneId}/sign-agreement:
    post:
      tags: [Check-in]
      summary: Store agreement signature
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [signaturePayload]
              properties:
                signaturePayload:
                  type: string
                  description: PNG signature as a full data URL (data:image/png;base64,...) or raw base64 payload.
                sessionId:
                  type: string
                  format: uuid
                  description: Optional lane session id; if omitted, the server uses the latest active session for the lane.
      responses:
        '200':
          description: Signature stored

  /v1/checkin/lane/{laneId}/kiosk-ack:
    post:
      tags: [Check-in]
      summary: Kiosk acknowledgement of completion (UI-only; does not end/clear the lane session)
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: false
      responses:
        '200':
          description: Kiosk acknowledged
        '404':
          description: No session found

  /v1/checkin/lane/{laneId}/customer-confirm:
    post:
      tags: [Check-in]
      summary: Customer confirms cross-type assignment
      parameters:
        - name: laneId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [confirmed]
              properties:
                confirmed:
                  type: boolean
      responses:
        '200':
          description: Confirmation recorded

  /v1/checkin/lane-sessions:
    get:
      tags: [Check-in]
      summary: Get active lane sessions for office dashboard
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of active lane sessions

  /v1/inventory/summary:
    get:
      tags: [Inventory]
      summary: Get inventory summary by status and type
      responses:
        '200':
          description: Inventory summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InventorySummary'

  /v1/inventory/detailed:
    get:
      tags: [Inventory]
      summary: Get detailed inventory with occupancy info (active check-in/out times)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Detailed inventory (rooms + lockers)
          content:
            application/json:
              schema:
                type: object
                properties:
                  rooms:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        number:
                          type: string
                        tier:
                          type: string
                        status:
                          type: string
                        floor:
                          type: integer
                        lastStatusChange:
                          type: string
                        assignedTo:
                          type: string
                          nullable: true
                        assignedMemberName:
                          type: string
                          nullable: true
                        overrideFlag:
                          type: boolean
                        occupancyId:
                          type: string
                          format: uuid
                          nullable: true
                        checkinAt:
                          type: string
                          nullable: true
                        checkoutAt:
                          type: string
                          nullable: true
                  lockers:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        number:
                          type: string
                        status:
                          type: string
                        assignedTo:
                          type: string
                          nullable: true
                        assignedMemberName:
                          type: string
                          nullable: true
                        occupancyId:
                          type: string
                          format: uuid
                          nullable: true
                        checkinAt:
                          type: string
                          nullable: true
                        checkoutAt:
                          type: string
                          nullable: true

  /v1/cleaning/batch:
    post:
      tags: [Cleaning]
      summary: Batch update room statuses (DIRTY→CLEANING or CLEANING→CLEAN)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [scanned]
              properties:
                scanned:
                  type: array
                  items:
                    type: object
                    required: [roomId, fromStatus, toStatus]
                    properties:
                      roomId:
                        type: string
                        format: uuid
                      fromStatus:
                        type: string
                        enum: [DIRTY, CLEANING, CLEAN]
                      toStatus:
                        type: string
                        enum: [DIRTY, CLEANING, CLEAN]
                      override:
                        type: boolean
                        default: false
                      overrideReason:
                        type: string
      responses:
        '200':
          description: Batch update completed

  /v1/checkout/resolve-key:
    post:
      tags: [Checkout]
      summary: Resolve key tag for checkout
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token, kioskDeviceId]
              properties:
                token:
                  type: string
                kioskDeviceId:
                  type: string
      responses:
        '200':
          description: Key resolved

  /v1/checkout/request:
    post:
      tags: [Checkout]
      summary: Create checkout request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [occupancyId, kioskDeviceId, checklist]
              properties:
                occupancyId:
                  type: string
                  format: uuid
                kioskDeviceId:
                  type: string
                checklist:
                  type: object
                  properties:
                    lockerKey:
                      type: boolean
                    towel:
                      type: boolean
                    roomKey:
                      type: boolean
                    bedSheets:
                      type: boolean
                    tvRemote:
                      type: boolean
      responses:
        '200':
          description: Checkout request created

  /v1/checkout/requests/{id}/claim:
    post:
      tags: [Checkout]
      summary: Claim checkout request for verification
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Request claimed

  /v1/checkout/requests/{id}/complete:
    post:
      tags: [Checkout]
      summary: Complete checkout verification
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                note:
                  type: string
      responses:
        '200':
          description: Checkout completed

  /v1/agreements/active:
    get:
      tags: [Agreements]
      summary: Get active agreement
      responses:
        '200':
          description: Active agreement
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agreement'

  /v1/upgrades/waitlist:
    post:
      tags: [Upgrades]
      summary: Join waitlist for upgrade
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sessionId, desiredRoomType, acknowledgedDisclaimer]
              properties:
                sessionId:
                  type: string
                  format: uuid
                desiredRoomType:
                  type: string
                  enum: [STANDARD, DOUBLE, SPECIAL]
                acknowledgedDisclaimer:
                  type: boolean
      responses:
        '200':
          description: Waitlist entry created

  /v1/visits:
    post:
      tags: [Visits]
      summary: Create initial visit
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [customerId, rentalType]
              properties:
                customerId:
                  type: string
                  format: uuid
                rentalType:
                  type: string
                  enum: [STANDARD, DOUBLE, SPECIAL, LOCKER, GYM_LOCKER]
                roomId:
                  type: string
                  format: uuid
                lockerId:
                  type: string
                  format: uuid
                lane:
                  type: string
      responses:
        '200':
          description: Visit created

  /v1/visits/{id}/renew:
    post:
      tags: [Visits]
      summary: Renew visit (add 6-hour block)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [rentalType]
              properties:
                rentalType:
                  type: string
                  enum: [STANDARD, DOUBLE, SPECIAL, LOCKER, GYM_LOCKER]
                roomId:
                  type: string
                  format: uuid
                lockerId:
                  type: string
                  format: uuid
                lane:
                  type: string
      responses:
        '200':
          description: Visit renewed

  /v1/admin/staff:
    get:
      tags: [Admin]
      summary: List all staff
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of staff members
        '403':
          description: Admin access required

    post:
      tags: [Admin]
      summary: Create staff member
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, role]
              properties:
                name:
                  type: string
                role:
                  type: string
                  enum: [STAFF, ADMIN]
                pin:
                  type: string
      responses:
        '200':
          description: Staff created
        '403':
          description: Admin access required

  /v1/admin/staff/{id}/reset-pin:
    post:
      tags: [Admin]
      summary: Reset staff PIN
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pin]
              properties:
                pin:
                  type: string
      responses:
        '200':
          description: PIN reset
        '403':
          description: Admin access required

  /v1/metrics/upgrades:
    get:
      tags: [Metrics]
      summary: Get upgrade metrics
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Upgrade metrics

  /v1/keys/resolve:
    post:
      tags: [Keys]
      summary: Resolve key tag to room information
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token:
                  type: string
      responses:
        '200':
          description: Room information

  /v1/waitlist:
    get:
      tags: [Waitlist]
      summary: List waitlist entries (ACTIVE/OFFERED/etc)
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [ACTIVE, OFFERED, COMPLETED, CANCELLED, EXPIRED]
      responses:
        '200':
          description: Waitlist entries
          content:
            application/json:
              schema:
                type: object
                properties:
                  entries:
                    type: array
                    items:
                      type: object
                      properties:
                        id: { type: string, format: uuid }
                        desiredTier: { type: string, enum: [STANDARD, DOUBLE, SPECIAL] }
                        backupTier: { type: string }
                        status: { type: string }
                        createdAt: { type: string, format: date-time }
                        offeredAt: { type: string, format: date-time, nullable: true }
                        completedAt: { type: string, format: date-time, nullable: true }
                        displayIdentifier: { type: string }
                        currentRentalType: { type: string }

  /v1/waitlist/{id}/offer:
    post:
      tags: [Waitlist]
      summary: Offer upgrade to a waitlist entry
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [waitlistId, roomId]
              properties:
                waitlistId: { type: string, format: uuid }
                roomId: { type: string, format: uuid }
      responses:
        '200':
          description: Offered

  /v1/waitlist/{id}/cancel:
    post:
      tags: [Waitlist]
      summary: Cancel a waitlist entry (requires recent re-auth)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [waitlistId]
              properties:
                waitlistId: { type: string, format: uuid }
                reason: { type: string }
      responses:
        '200':
          description: Cancelled
        '403':
          description: Re-authentication required

  /v1/upgrades/fulfill:
    post:
      tags: [Upgrades]
      summary: Start upgrade fulfillment (create payment intent)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [waitlistId, roomId, acknowledgedDisclaimer]
              properties:
                waitlistId: { type: string, format: uuid }
                roomId: { type: string, format: uuid }
                acknowledgedDisclaimer: { type: boolean }
      responses:
        '200':
          description: Payment intent created for upgrade
          content:
            application/json:
              schema:
                type: object
                properties:
                  waitlistId: { type: string, format: uuid }
                  paymentIntentId: { type: string, format: uuid }
                  upgradeFee: { type: number }
                  newRoomId: { type: string, format: uuid }
                  newRoomNumber: { type: string }
                  newRoomTier: { type: string }
                  fromTier: { type: string }
                  originalTotal: { type: number, nullable: true }
                  originalCharges:
                    type: array
                    items:
                      type: object
                      properties:
                        description: { type: string }
                        amount: { type: number }
                      required: [description, amount]

  /v1/upgrades/complete:
    post:
      tags: [Upgrades]
      summary: Complete upgrade after payment (requires recent re-auth)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [waitlistId, paymentIntentId]
              properties:
                waitlistId: { type: string, format: uuid }
                paymentIntentId: { type: string, format: uuid }
      responses:
        '200':
          description: Upgrade completed
        '403':
          description: Re-authentication required

  /v1/admin/customers:
    get:
      tags: [Admin]
      summary: Search customers (admin)
      security:
        - bearerAuth: []
      parameters:
        - name: search
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 25
      responses:
        '200':
          description: Customer search results

  /v1/admin/customers/{id}:
    patch:
      tags: [Admin]
      summary: Update customer admin fields (notes, past due) (requires recent re-auth)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                notes: { type: string, nullable: true }
                pastDueBalance: { type: number, minimum: 0 }
      responses:
        '200':
          description: Updated customer
        '403':
          description: Re-authentication required

  /v1/admin/reports/cash-totals:
    get:
      tags: [Admin]
      summary: Demo cash totals for today (by method, by register)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Cash totals

  /v1/documents/by-session/{sessionId}:
    get:
      tags: [Documents]
      summary: List agreement documents by lane session (verification)
      security:
        - bearerAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Documents for the session
          content:
            application/json:
              schema:
                type: object
                properties:
                  documents:
                    type: array
                    items:
                      type: object
                      properties:
                        id: { type: string, format: uuid }
                        doc_type: { type: string, example: AGREEMENT_PDF }
                        mime_type: { type: string, example: application/pdf }
                        created_at: { type: string, format: date-time }
                        has_signature: { type: boolean }
                        signature_hash_prefix: { type: string, nullable: true }
                        has_pdf: { type: boolean, nullable: true }
        '401':
          description: Unauthorized

  /v1/documents/{documentId}/download:
    get:
      tags: [Documents]
      summary: Download agreement PDF bytes (verification)
      security:
        - bearerAuth: []
      parameters:
        - name: documentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Agreement PDF bytes
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        '404':
          description: Document not found / PDF not stored
          content:
            application/json:
              schema:
                type: object
                properties:
                  error: { type: string }
        '401':
          description: Unauthorized

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: opaque
      description: Opaque session token from PIN or WebAuthn login (stored/validated server-side; not a JWT)

  schemas:
    Staff:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        role:
          type: string
          enum: [STAFF, ADMIN]
        active:
          type: boolean

    Room:
      type: object
      properties:
        id:
          type: string
          format: uuid
        number:
          type: string
        type:
          type: string
          enum: [STANDARD, DOUBLE, SPECIAL, LOCKER]
        status:
          type: string
          enum: [DIRTY, CLEANING, CLEAN, OCCUPIED]
        floor:
          type: integer

    Locker:
      type: object
      properties:
        id:
          type: string
          format: uuid
        number:
          type: string
        status:
          type: string

    InventorySummary:
      type: object
      properties:
        byType:
          type: object
          additionalProperties:
            type: object
            properties:
              clean:
                type: integer
              cleaning:
                type: integer
              dirty:
                type: integer
              total:
                type: integer
        lockers:
          type: object
          properties:
            clean:
              type: integer
            total:
              type: integer

    Agreement:
      type: object
      properties:
        id:
          type: string
          format: uuid
        version:
          type: string
        title:
          type: string
        bodyText:
          type: string
        active:
          type: boolean
        createdAt:
          type: string
          format: date-time
